# 질병코딩지침서 PDF 파싱 작업 일지

**날짜**: 2025-11-04
**작업자**: Claude Code
**작업 시간**: 약 2시간

## 📋 작업 개요

한국표준질병사인분류 질병코딩지침서 PDF(128페이지)를 Upstage Document Parse API를 활용하여 파싱하고, 결과를 평가하여 개선 방안을 도출함.

## ✅ 완료 작업

### 1. 초기 PDF 파싱 (기본 분할 방식)

#### 작업 내용
- **파일**: `붙임1_2021년+한국표준질병사인분류+질병코딩지침서.pdf` (128페이지, 1.91MB)
- **스크립트**: `parse_kcd_guidebook.py` 작성
- **분할 방식**: 50페이지씩 균등 분할 (pypdf 사용)
  - 청크 1: p.1-50 (50페이지)
  - 청크 2: p.51-100 (50페이지)
  - 청크 3: p.101-128 (28페이지)

#### 파싱 결과
✅ **성공**: 3/3 청크 모두 파싱 완료
- 총 210,650자 텍스트 추출
- 1,500개 elements 추출
- 413개 headings 식별
- 파싱 시간: 약 18초 (청크당 4-7초)

#### 출력 파일
- `data/hira_master/parsed/붙임1_2021년+한국표준질병사인분류+질병코딩지침서.json`
- `data/hira_master/parsed/붙임1_2021년+한국표준질병사인분류+질병코딩지침서.html`

### 2. 파싱 결과 평가

#### 문서 구조 분석
주요 섹션 구조 파악:
- 질병분류지침서 이용 안내 (p.3-5)
- 코드체계 및 규약 (p.9-13)
- 일반분류지침 (p.17-25)
- 장 및 질환별 분류지침 (p.29-107)
  - I장 ~ XXIII장 (23개 장)
- 부록 (p.107~)

#### 문제점 발견

**⚠️ 데이터 파편화 문제**

1. **50페이지 경계**:
   - 제II장 신생물 > DCG.II.2 섹션 **중간**에서 분할
   - 하나의 코딩 지침이 두 청크로 분리됨

2. **100페이지 경계**:
   - 제XXI장 건강상태 섹션 **중간**에서 분할
   - 장(Chapter) 단위가 분리됨

**근본 원인**:
- 단순 페이지 수 기준 기계적 분할
- 목차 구조 무시
- 섹션 경계 고려 없음

### 3. 평가 보고서 작성

**파일**: `parse_evaluation_report.md`

#### 보고서 내용
- 파싱 결과 요약 및 통계
- 문서 구조 상세 분석 (23개 장 매핑)
- 데이터 파편화 문제 상세 분석
- 3가지 개선 방안 제시:
  1. ⭐ 목차 기반 지능형 분할 (권장)
  2. 헤딩 경계 고려 동적 분할
  3. 중첩(Overlap) 분할
- 단기/중기/장기 권장 사항 제시

### 4. 개선된 파싱 스크립트 개발

**파일**: `parse_kcd_guidebook_smart.py`

#### 주요 기능
- `SmartPDFSplitParser` 클래스 구현
- **지능형 분할 전략**:
  - 주요 섹션 경계 식별 (수동 정의 또는 자동 분석)
  - 목표 페이지 수(50p) 고려하되 섹션 경계 우선
  - 문맥 보존을 위한 섹션 단위 분할

#### 개선된 분할 계획
```
청크 1: p.1-42   (42페이지) - 규약 + 일반지침 + I~II장
청크 2: p.43-90  (48페이지) - III~XVIII장
청크 3: p.91-128 (38페이지) - XIX~XXIII장 + 부록
```

#### 장점
- ✅ 각 청크가 의미 있는 단위로 구성
- ✅ 섹션 중간 분할 방지 → 문맥 보존
- ✅ 독립적 분석 가능한 청크 생성
- ✅ 메타데이터에 포함 섹션 정보 기록

## 📊 성과

### 정량적 성과
- ✅ 128페이지 PDF 완전 파싱 (100% 성공)
- ✅ 210,650자 텍스트 추출
- ✅ 1,500개 구조화된 elements
- ✅ 파싱 시간 단축 (18초)

### 정성적 성과
- ✅ 데이터 파편화 문제 식별 및 분석
- ✅ 목차 기반 지능형 분할 방법론 개발
- ✅ 재사용 가능한 스크립트 구현
- ✅ 상세한 평가 보고서 작성

## 📂 생성된 파일

### 실행 스크립트
1. `parse_kcd_guidebook.py` - 기본 균등 분할 파서
2. `parse_kcd_guidebook_smart.py` - 지능형 섹션 기반 파서 ⭐

### 파싱 결과
3. `data/hira_master/parsed/붙임1_2021년+한국표준질병사인분류+질병코딩지침서.json`
4. `data/hira_master/parsed/붙임1_2021년+한국표준질병사인분류+질병코딩지침서.html`

### 문서
5. `parse_evaluation_report.md` - 파싱 결과 평가 보고서
6. `docs/journal/2025-11-04_kcd_guidebook_parsing.md` - 작업 일지 (본 문서)

## 🔧 기술 스택

- **PDF 처리**: `pypdf` (이미 설치됨)
- **API**: Upstage Document Parse API
  - OCR 활성화
  - HTML 출력 형식
  - 50~100페이지 청크 처리 가능
- **환경**: Windows, Python 3.x
- **토큰 사용**: 약 57,000 / 200,000 (28.5%)

## 🎯 다음 단계 (권장)

### 즉시 가능
1. ✅ 현재 파싱 결과로 전체 문서 검색/분석 시작
   - 키워드 검색, 질병 코드 매핑 등에 활용 가능

### 개선 작업 (선택)
2. `parse_kcd_guidebook_smart.py` 실행하여 개선된 결과 생성
   - 섹션 경계 보존 확인
   - 기존 결과와 비교 분석

### 고도화 (장기)
3. Semantic Chunking 도입
   - 각 DCG 지침 단위로 독립 문서화
   - 임베딩 기반 유사도 분석
   - 질병 코드별 관련 지침 자동 연결

## 💡 학습 사항

### 문제 해결
- **문제**: PDF가 너무 커서 한 번에 파싱 불가
- **해결**: 청크 분할 → 독립 파싱 → 병합 전략
- **교훈**: 단순 분할은 데이터 파편화 유발 → 구조 인식 분할 필요

### 기술적 인사이트
- Upstage API는 100페이지 제한 → 50페이지 청크가 안전
- pypdf는 권한 문제 없이 PDF 분할 가능
- 목차 구조 분석이 고품질 파싱의 핵심

### 프로젝트 관리
- 파싱 결과 평가 → 문제 식별 → 개선 방안 → 재구현 사이클
- 상세한 메타데이터 기록이 추후 분석에 중요
- 평가 보고서 작성으로 의사결정 근거 확보

## 📝 비고

### 발생한 이슈
- PyMuPDF 설치 권한 문제 (miniconda 환경) → pypdf로 대체 성공
- UTF-8 출력 인코딩 문제 (Windows) → codecs.getwriter로 해결

### 환경 설정
- `.env` 파일에 `UPSTAGE_API_KEY` 설정 완료
- 기존 프로젝트에 유사 스크립트 존재 확인:
  - `hira_master/split_and_parse_pdfs.py` (pypdf 사용)
  - `hira_cancer/parsers/upstage_split_parser.py` (pymupdf 사용)
  - 두 스크립트를 참고하여 통합 개선

## ✨ 결론

**성공적으로 128페이지 질병코딩지침서 PDF를 파싱하고, 데이터 파편화 문제를 식별하여 지능형 분할 방법론을 개발함.**

현재 파싱 결과는 전체 문서 검색/참조 용도로 즉시 활용 가능하며, 개선된 스크립트를 통해 더 높은 품질의 구조화된 데이터를 생성할 수 있는 기반을 마련함.

---

**작업 종료**: 2025-11-04
**상태**: ✅ 완료
**다음 작업**: 지능형 파서 실행 또는 현재 결과 활용 시작
