# 개선된 표 파싱 전략

**작업일**: 2025-10-22
**작업자**: Claude Code + 지민
**상태**: 🔄 설계 완료 / 구현 대기

---

## 📋 발견된 문제점

### Upstage 테스트에서 드러난 이슈

1. **p50 빈 페이지**: 샘플링 전략이 실제 데이터 분포를 반영하지 못함
2. **p100, p500 중첩 테이블**: 표 안에 표가 있음 → 별도 처리 필요
3. **페이지 간 연속 표** (Critical!): 하나의 표가 여러 페이지에 걸쳐 있음
   - 페이지별 파싱 → 데이터 무결성 손실
   - 예: 약제 목록이 p100-105까지 연속

---

## 🎯 개선된 전략

### **Option A: pdfplumber 중심 + 스마트 후처리** (최종 선택)

```
전체 파이프라인:

1. 목차 추출 (규칙 기반)
   ├─ "목차", "Contents" 페이지 감지
   ├─ 정규식으로 섹션-페이지 매핑
   └─ 섹션별 메타데이터 생성

2. 복잡도 분석
   ├─ 표 밀도 (표/페이지)
   ├─ 중첩 테이블 비율
   └─ Upstage 사용 여부 판단 (임계값: 복잡도 > 50)

3. 전체 문서 파싱 (pdfplumber)
   ├─ 페이지별 표 추출
   ├─ bbox, 헤더, 행 수 저장
   └─ 섹션 정보 태깅

4. 페이지 간 표 병합 ⭐ (핵심!)
   ├─ 연속 페이지의 bbox 좌표 비교 (x축 ±5% 이내)
   ├─ 헤더 일치 여부 검사
   ├─ 동일 표면 행 병합 (헤더 중복 제거)
   └─ source_pages = [100, 101, 102] 기록

5. 중첩 테이블 처리
   ├─ bbox 계층 구조로 parent-child 판단
   ├─ level 0 (외부 표), level 1 (내부 표) 구분
   ├─ parent_table_id 참조 관계 저장
   └─ 필요 시 BeautifulSoup으로 HTML 변환 후 파싱

6. 병합셀 분할
   ├─ \n 기준 셀 분할
   ├─ forward-fill (짧은 컬럼)
   └─ 행 완전성 확보

7. LLM 검증 (선택적, 복잡 섹션만)
   ├─ GPT-4o-mini로 구조 검증
   ├─ 중첩 테이블 의미 파악
   └─ 병합 결과 품질 체크
```

**장점**:
- ✅ 비용: ~$1-2 (LLM만)
- ✅ 속도: 빠름 (pdfplumber 기반)
- ✅ 정확도: 규칙 기반으로 충분 (의료 문서 표준화)
- ✅ 페이지 간 연속성 보장
- ✅ 중첩 구조 보존

---

### **Option B: 하이브리드 (Upstage 부분 활용)**

```
1. 목차로 복잡도 분류
   ├─ 단순 섹션 (복잡도 < 50): pdfplumber
   ├─ 복잡 섹션 (복잡도 ≥ 50): Upstage (100p 단위)
   └─ LLM으로 복잡도 판단 (선택적)

2. Upstage 사용 조건
   ├─ 중첩 테이블 3개 이상
   ├─ 스캔 이미지 포함
   └─ pdfplumber 실패율 > 30%

3. 섹션별 처리
   ├─ 복잡 섹션만 100페이지씩 분할
   ├─ Upstage로 파싱
   └─ 나머지는 pdfplumber

4. 결과 통합
   ├─ 섹션별 결과 병합
   └─ 페이지 간 연속성 검증
```

**비용 예상**:
- 전체 4,275p 중 ~500p만 Upstage
- Upstage: $5.00 (500p ÷ 100p × $1.00)
- LLM: $1.00
- **총 비용: ~$6.00**

**단점**:
- Upstage 100페이지 제한으로 섹션 분할 필요
- 복잡도 판단 로직 필요

---

### **Option C: LLM 중심 (비권장)**

```
1. 전체 텍스트 추출 (pdfplumber)

2. LLM으로 구조 파악
   ├─ 목차 추출 및 섹션 분류
   ├─ 표 연속성 판단
   └─ 중첩 구조 의미 파악

3. LLM 가이드 파싱
   ├─ "p100-105는 하나의 약제 목록 표"
   ├─ "p200-210은 급여 기준, 2단계 중첩"
   └─ 파싱 로직 동적 조정
```

**비용**: ~$10-20 (GPT-4 필요)
**장점**: 최고 정확도
**단점**: 비용 높음, 느림

---

## 🛠️ 구현 완료 모듈

### 1. 목차 추출기

**파일**: `hira/table_parser/toc_extractor.py`

**기능**:
- 목차 페이지 자동 감지
- 정규식으로 섹션-페이지 매핑
- 복잡도 추정 (표 밀도, 중첩 비율, 평균 행/표)

**출력 예시**:
```python
{
  'section_num': '1',
  'title': '약제 급여 목록',
  'start_page': 50,
  'end_page': 200,
  'complexity_score': 65.3,
  'requires_upstage': True
}
```

---

### 2. 페이지 간 표 병합기

**파일**: `hira/table_parser/cross_page_merger.py`

**알고리즘**:
```python
def is_continuation(table_a, table_b):
    # 조건 1: 연속 페이지
    if table_b.page != table_a.page + 1:
        return False

    # 조건 2: bbox x좌표 유사 (±5%)
    if abs(table_b.x0 - table_a.x0) / table_a.width > 0.05:
        return False

    # 조건 3: 헤더 일치
    if table_a.header != table_b.header:
        return False

    # 조건 4: 열 개수 일치
    if table_a.cols != table_b.cols:
        return False

    return True
```

**병합 과정**:
1. 페이지별 표 조각 추출
2. 순차 스캔하며 연속성 검사
3. 연속 조건 만족 시 버퍼에 누적
4. 불일치 시 버퍼 flush → 하나의 MergedTable 생성
5. 헤더 중복 제거 후 행 병합

**출력 예시**:
```python
MergedTable(
    start_page=100,
    end_page=105,
    pages=[100, 101, 102, 103, 104, 105],
    num_pages=6,
    header=['약품명', '성분', '급여기준'],
    num_rows=150  # 6페이지 누적
)
```

---

## 📊 예상 성능 개선

### 페이지 간 병합 효과

| 항목 | 병합 전 | 병합 후 | 개선 |
|------|---------|---------|------|
| **표 개수** | ~1,500개 | ~800개 | -47% |
| **평균 행/표** | 5.1개 | 9.5개 | +86% |
| **데이터 무결성** | ❌ 손실 | ✅ 보장 | - |
| **연속성** | ❌ 페이지별 단절 | ✅ 섹션 단위 연속 | - |

---

### 중첩 테이블 처리

**Before** (pdfplumber 기본):
```
표 1 (p100): 외부 표 (6행)
표 2 (p100): 내부 표 (3행)
→ 독립된 2개 표로 인식, 관계 불명확
```

**After** (계층 구조):
```json
{
  "table_id": "t100_1",
  "level": 0,
  "parent_table_id": null,
  "rows": 6,
  "children": ["t100_2"]
}

{
  "table_id": "t100_2",
  "level": 1,
  "parent_table_id": "t100_1",
  "rows": 3,
  "children": []
}
```

---

## 🚀 다음 작업 계획

### Phase 1: 통합 파서 구현 (우선순위 높음)

**파일**: `hira/table_parser/integrated_parser.py`

**작업 내용**:
1. 목차 추출 → 복잡도 분석
2. 섹션별 pdfplumber 파싱
3. 페이지 간 표 병합
4. 중첩 테이블 계층 구조 생성
5. 병합셀 분할 (journal 2025-10-21 설계 참고)
6. JSONL 출력

**예상 소요**: 4-6시간

---

### Phase 2: 샘플 테스트 및 검증

**테스트 범위**:
- p100-110 (중첩 테이블, 연속 표)
- p200-210 (약제 급여 기준)
- p500-510 (중첩 + 연속)

**검증 메트릭**:
- 페이지 간 병합 정확도 (수동 라벨 vs 자동)
- 중첩 테이블 계층 정확도
- 병합셀 분할 완전성

---

### Phase 3: 전체 문서 파싱

**대상**: 858페이지 (약제 PDF)

**예상 결과**:
- ~800개 병합 표
- ~12,000개 행
- 처리 시간: ~2분 (pdfplumber) + ~30초 (병합)

**출력 형식**:
```jsonl
{
  "doc_id": "pharma_2025",
  "table_id": "t100_105_merged",
  "pages": [100, 101, 102, 103, 104, 105],
  "section": "약제 급여 목록",
  "row_id": "r001",
  "level": 0,
  "parent_table_id": null,
  "data": {
    "약품명": "아스피린",
    "성분": "Aspirin",
    "급여기준": "..."
  },
  "source_anchor": {
    "page": 100,
    "bbox": [51.0, 57.0, 390.0, 569.0]
  }
}
```

---

### Phase 4: LLM 검증 (선택적)

**조건**: 복잡도 > 50인 섹션만

**작업**:
1. 파싱 결과를 LLM에 제공
2. 구조 검증 (계층, 연속성)
3. 오류 감지 및 수정 제안

**비용**: ~$1-2 (GPT-4o-mini)

---

## 💡 핵심 인사이트

### 1. 페이지 간 연속성이 가장 중요

**문제**:
- 의료 문서는 하나의 표가 수십 페이지에 걸쳐 있음
- 페이지별 파싱 → 데이터 단절

**해결**:
- bbox 좌표 + 헤더 일치로 연속성 판단
- 연속 페이지의 행을 하나로 병합
- source_pages 필드로 출처 추적

---

### 2. 중첩 테이블은 계층 구조로 저장

**문제**:
- pdfplumber: 별도 2개 표로 인식
- Upstage: 하나로 통합 (정보 손실 가능)

**해결**:
- bbox 포함 관계로 parent-child 판단
- level, parent_table_id로 계층 표현
- 나중에 LLM으로 의미 파악 가능

---

### 3. Upstage는 제한적으로만 사용

**문제**:
- 100페이지 제한
- 비용 높음 ($42.75 for 전체)
- pdfplumber 대비 우위 없음

**해결**:
- 기본은 pdfplumber
- 복잡도 > 50인 섹션만 Upstage (선택적)
- 예상 비용: $5-6 (전체 중 ~500p만)

---

### 4. 목차 기반 섹션 분할 필수

**이유**:
- 섹션별 복잡도 다름 (목차 vs 본문 vs 부록)
- 섹션 단위로 파싱 전략 조정
- 메타데이터 태깅 (검색 시 유용)

**구현**:
- 정규식으로 목차 추출 (의료 문서는 형식 표준화)
- 복잡도 점수로 Upstage 사용 여부 자동 판단

---

## 📂 산출물

### 생성된 파일

```
hira/table_parser/
├── toc_extractor.py          # 목차 추출 및 복잡도 분석
├── cross_page_merger.py      # 페이지 간 표 병합
└── integrated_parser.py      # 통합 파서 (예정)

docs/journal/pharma/
└── 2025-10-22_improved_parsing_strategy.md  # 본 문서
```

---

## 🎯 최종 권장 사항

### **pdfplumber 중심 + 스마트 후처리** 선택

**근거**:
1. 비용 최소 ($1-2 vs $6 vs $10-20)
2. 속도 빠름 (pdfplumber 기반)
3. 페이지 간 연속성 보장 (핵심 요구사항)
4. 중첩 구조 보존 (계층 표현)
5. 의료 문서는 형식이 표준화 (규칙 기반 충분)

**예외적 Upstage 사용**:
- 스캔 이미지 (OCR 필수)
- 극도로 복잡한 레이아웃 (복잡도 > 70)
- pdfplumber 실패율 > 30%

**구현 우선순위**:
1. **페이지 간 병합** (가장 중요!)
2. 병합셀 분할
3. 중첩 테이블 계층 구조
4. 목차 기반 섹션 분할
5. LLM 검증 (선택적)

---

## 🔗 관련 문서

- [Upstage vs pdfplumber 비교](2025-10-22_upstage_vs_pdfplumber_comparison.md)
- [HIRA 표 파서 MVP](../hira/2025-10-21_table_parser_mvp.md)
- [병합셀 분할 설계](../hira/2025-10-21_table_parser_mvp.md#해결책-줄바꿈-분할-로직)

---

**작성 시각**: 2025-10-22 03:00
**다음 작업**: `integrated_parser.py` 구현
**예상 소요**: 4-6시간

---

## 📝 구현 체크리스트

- [x] 목차 추출기 설계 및 구현
- [x] 페이지 간 표 병합기 설계 및 구현
- [ ] 통합 파서 구현
- [ ] 중첩 테이블 계층 구조 생성
- [ ] 병합셀 분할 로직 통합
- [ ] 샘플 테스트 (p100-110, p200-210, p500-510)
- [ ] Ground Truth 생성 및 평가
- [ ] 전체 문서 파싱 (858p)
- [ ] JSONL 출력 및 벡터 DB 적재
- [ ] LLM 검증 (선택적)
