# 업무 일지 - 2025.11.05

## 📋 작업 개요
의료 데이터 파싱 및 정규화 작업
- KCD-9 Master file 정규화
- KDRG 분류집 지능형 파싱
- 수술/처치 코드 매핑 테이블 구축

---

## ✅ 완료 작업

### 1. 프로젝트 구조 정리
**작업 시간:** 09:00 - 09:30

**배경:**
- KCD는 통계청(KSSC) 관리 → 폴더 구조 재정리 필요

**작업 내용:**
- `hira_master`에서 KCD 8차 관련 파일 이동
- `data/kssc/kcd-8th/` 폴더로 재구성

**이동된 파일:**
```
✓ 원본 PDF 3개
  - KCD-8 1권
  - 질병코딩지침서
  - 질병코딩사례집
✓ parsed/ 파일 3개
✓ parsed_smart/ 파일 4개
총 10개 파일 이동 완료
```

---

### 2. KCD-9 Master File 분석 및 정규화
**작업 시간:** 10:00 - 11:30

**입력 데이터:**
- `제9차 한국표준질병ㆍ사인분류 2차 정오 DB masterfile_251031.xlsx`
- 54,126개 행 (3개 시트)

**수행 작업:**
1. Excel Master file 구조 분석
2. 데이터 정제 및 타입 변환
3. JSON 형식으로 정규화

**출력 결과:**
```
📂 data/kssc/kcd-9th/normalized/
├── kcd9_full.json (54,125개 코드)
├── kcd9_usable_codes.json (44,706개 사용 가능)
├── kcd9_code_map.json (21,589개 고유 코드)
└── kcd9_statistics.json (22개 대분류)
```

**주요 통계:**
- 총 코드: 54,125개 (동의어 포함)
- 최하위 코드: 44,706개 (실제 진단 사용 가능)
- 고유 코드: 21,589개
- 대분류(Chapter): 22개
- 가장 많은 코드: 근골격계 (M00-M99) 17,510개

**기술적 특이사항:**
- 정오차수 데이터가 문자열 형식("2차('25.10.31.)")
- 중복 코드 제거 로직 적용
- 분류 체계: 대→중→소→세→세세→세세세

---

### 3. KDRG 분류집 목차 추출 및 구조 분석
**작업 시간:** 13:00 - 14:00

**도구:** PyMuPDF (fitz)

**입력 데이터:**
- `KDRG 분류집(신포괄지불제도용 ver1.4).pdf`
- 1,274페이지

**수행 작업:**
1. PDF 목차(TOC) 추출
2. MDC(Major Diagnostic Category) 구조 분석
3. 지능형 분할 전략 수립

**분석 결과:**
- 발견된 MDC: 11개
- 제안 청크: 28개
- 평균 청크 크기: 43.4페이지
- 분할 방식: 50페이지 이하는 유지, 초과 시 균등 분할

**주요 MDC:**
```
MDC 01: 신경계 (62p) → 2개 Part
MDC 08: 근골격계 (196p) → 4개 Part
MDC 14: 임신/출산 (234p) → 5개 Part
MDC 22: 화상 (186p) → 4개 Part
```

**출력:**
- `kdrg_structure.json` - 구조 정보 및 분할 계획

---

### 4. KDRG 분류집 지능형 파싱
**작업 시간:** 14:30 - 15:00 (실행 시간: 약 4분)

**방법:** Upstage Document AI API

**파싱 전략:**
- 목차 구조 기반 MDC 단위 분할
- 섹션 중간 끊김 방지
- 28개 청크로 분산 파싱

**결과:**
```
✓ 28개 청크 모두 성공 (실패 0개)
✓ 파싱 페이지: 1,216페이지
✓ 추출 텍스트: 5,225,761자
✓ 추출 요소: 16,329개
✓ 소요 시간: 약 4분
```

**출력 파일:**
```
📂 data/hira_master/kdrg_parsed/
├── kdrg_smart.json (5.2MB)
└── kdrg_smart.html (5.2MB)
```

**기술적 성과:**
- 무작정 50페이지 분할 대신 지능형 분할로 품질 향상
- MDC 섹션 경계 유지
- 평균 8.5초/청크 처리 속도

---

### 5. KDRG 수술/처치 코드 추출
**작업 시간:** 15:00 - 15:30

**도구:** BeautifulSoup4

**입력:** kdrg_smart.html

**추출 로직:**
- HTML 테이블 파싱
- 3컬럼 구조 인식: 한글코드 | 영문코드 | 명칭
- 패턴 매칭: 한글코드(자\d+), 영문코드([A-Z]+\d+)
- 중복 제거

**결과:**
```
✓ 원본 추출: 5,555개
✓ 고유 코드: 1,487개
✓ 코드 유형: 자(1,357), 차(55), 저(23), 나(22) 등
```

**출력 파일:**
```
📂 data/hira_master/kdrg_parsed/codes/
├── kdrg_procedures_full.json (1,487개)
├── kdrg_korean_to_english.json (한→영)
├── kdrg_english_to_korean.json (영→한)
└── kdrg_search_index.json (2,955개)
```

**검증 결과:**
고시 예시 "췌장수술(자751, 자752, ...)" 매핑 성공
```
자751 → Q7511 → 췌장농양절개술 또는 주위배액술
자752 → Q7520 → 췌장손상봉합술
자757 → Q7571 → 췌십이지장절제술-위플씨수술
```

---

## 📊 최종 산출물

### 1. KCD-9 정규화 데이터
```
📂 data/kssc/kcd-9th/normalized/
├── kcd9_full.json (54,125 codes)
├── kcd9_usable_codes.json (44,706 codes)
├── kcd9_code_map.json (21,589 codes)
└── kcd9_statistics.json (22 chapters)
```

### 2. KDRG 파싱 데이터
```
📂 data/hira_master/kdrg_parsed/
├── kdrg_smart.json (1,216p, 5.2MB)
├── kdrg_smart.html (5.2MB)
└── codes/
    ├── kdrg_procedures_full.json (1,487 codes)
    ├── kdrg_korean_to_english.json
    ├── kdrg_english_to_korean.json
    └── kdrg_search_index.json (2,955 entries)
```

### 3. 구조 정보
```
📂 data/hira_master/
└── kdrg_structure.json (MDC 구조 및 분할 정보)
```

---

## 🔧 기술 스택

**언어/라이브러리:**
- Python 3.x
- pandas (Excel 처리)
- PyMuPDF (PDF 목차 추출)
- pypdf (PDF 분할)
- BeautifulSoup4 (HTML 파싱)
- requests (API 호출)

**API:**
- Upstage Document AI (PDF → HTML/JSON 변환)

**환경:**
- Conda 가상환경: pharma

---

## 📈 데이터 규모

| 항목 | 수량 |
|-----|------|
| **질병코드 (KCD-9)** | 54,125개 |
| - 사용 가능 코드 | 44,706개 |
| - 고유 코드 | 21,589개 |
| **수술/처치코드 (KDRG)** | 1,487개 |
| **파싱 페이지** | 1,216페이지 |
| **추출 텍스트** | 5.2MB |
| **추출 요소** | 16,329개 |

---

## 💡 주요 성과

### 1. 데이터 품질 향상
- 무작정 분할 → 지능형 분할로 섹션 무결성 유지
- Master file 활용으로 PDF 파싱 불필요 최소화

### 2. 재사용 가능한 파이프라인 구축
- KCD 8차 파싱 스크립트
- KDRG 지능형 파싱 스크립트
- 코드 추출 및 정규화 스크립트
- → KCD 9차, 다른 문서에도 적용 가능

### 3. 실무 적용 가능성
- 고시 텍스트 자동 매핑 가능
- 코드 검색 시스템 구축 준비 완료
- 약품-질병-수술 연계 가능

---

## 🎯 다음 단계 제안

### 우선순위 1: 고시 자동 매핑
- 고시 텍스트에서 코드 패턴 인식
- "자751, 자752, ..." → 자동으로 명칭 변환
- 급여 기준 해석 자동화

### 우선순위 2: 통합 검색 시스템
- KCD-9 질병코드 검색
- KDRG 수술코드 검색
- 약가 데이터 연계
- API 또는 CLI 도구

### 우선순위 3: KCD 8차/9차 비교 분석
- 8차와 9차 신구대조표 활용
- 코드 변경 이력 추적
- 이전 데이터 마이그레이션 지원

### 우선순위 4: 관계 그래프 시각화
- 약품 → 적응증(질병) → 수술/처치
- 고시 조건 → 코드 매핑
- 네트워크 그래프 생성

---

## 📝 기술적 이슈 및 해결

### Issue 1: 정오차수 데이터 타입 오류
**문제:** `int()` 변환 시 "2차('25.10.31.)" 문자열 오류
**해결:** `str()` 타입으로 유지

### Issue 2: 변수 스코프 오류
**문제:** `NameError: name 'chunks' is not defined`
**해결:** 함수 파라미터로 `total_chunks` 전달

### Issue 3: BeautifulSoup 미설치
**문제:** HTML 파싱 라이브러리 없음
**해결:** `pip install beautifulsoup4`

---

## ⏱️ 작업 시간 요약

| 작업 | 소요 시간 |
|-----|----------|
| 프로젝트 구조 정리 | 30분 |
| KCD-9 정규화 | 1시간 30분 |
| KDRG 구조 분석 | 1시간 |
| KDRG 파싱 | 4분 (실행) + 30분 (준비) |
| 코드 추출 | 30분 |
| **총 작업 시간** | **약 4시간** |

---

## 📌 참고사항

### 파일 위치
- 작업 디렉토리: `C:\Jimin\scrape-hub`
- KCD 데이터: `data/kssc/`
- KDRG 데이터: `data/hira_master/`
- 스크립트: 루트 디렉토리

### 주요 스크립트
```
parse_kcd_guidebook_smart.py      # KCD 지침서 파싱
parse_kcd_casebook_smart.py       # KCD 사례집 파싱
analyze_kcd9_masterfile.py        # KCD-9 분석
normalize_kcd9_masterfile.py      # KCD-9 정규화
extract_kdrg_toc.py               # KDRG 목차 추출
parse_kdrg_smart.py               # KDRG 지능형 파싱
extract_kdrg_codes.py             # KDRG 코드 추출
```

---

## 🏁 결론

오늘 작업으로 의료 코드 데이터의 기반 구축을 완료했습니다.

**핵심 성과:**
1. ✅ KCD-9 54,125개 질병코드 정규화
2. ✅ KDRG 1,487개 수술코드 매핑
3. ✅ 재사용 가능한 파싱 파이프라인 구축
4. ✅ 고시 자동 매핑 기반 마련

다음 단계로 실제 고시 텍스트 파싱 및 자동 매핑 시스템을 구축하면,
의료 급여 기준 해석 자동화가 가능할 것으로 예상됩니다.

---

**작성일:** 2025.11.05
**작성자:** AI Assistant (Claude)
**다음 작업일:** TBD
